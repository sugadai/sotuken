"use strict";var _require=require("express"),text=_require.text,express=require("express"),session=require("express-session"),MySQLStore=require("express-mysql-session")(session),bcrypt=require("bcrypt"),_require2=require("express/lib/response"),redirect=_require2.redirect,json=_require2.json,type=_require2.type,app=express(),mysql=require("mysql"),cli=require("nodemon/lib/cli"),fs=require("fs"),_require3=require("csv-stringify/sync"),stringify=_require3.stringify,Iconv=require("iconv-lite"),_require4=require("console"),time=_require4.time,_require5=require("mysql/lib/protocol/constants/types"),TIME=_require5.TIME,_require6=require("path"),format=_require6.format,e=require("express"),nodemailer=require("nodemailer"),http=require("http"),server=http.createServer(app),io=require("socket.io")(server),port=3e3;app.use(express.static("public")),app.use(express.urlencoded({extended:!1}));var client=mysql.createConnection({host:"127.0.0.1",user:"root",password:"m.s.l_sd6016",database:"health",multipleStatements:!0});client.connect(function(e){e?console.log("error connecting: "+e.stack):console.log("success")});var options={host:"127.0.0.1",port:3306,user:"root",password:"m.s.l_sd6016",database:"my_database"},sessionStore=new MySQLStore(options),sess={secret:"secretsecretsecret",cookie:{maxAge:6e5},store:new MySQLStore(options),resave:!1,saveUninitialized:!1};"production"===app.get("env")&&(app.set("trust proxy",1),sess.cookie.secure=!0),app.use(session(sess));var obj,record,user_id,rate_data,rate_time,rate_date,porter=nodemailer.createTransport({service:"gmail",port:"465",secure:"true",auth:{user:"dayoujianyuan091@gmail.com",pass:"xxlfdjfoilunnheo"}}),_require7=require("python-shell"),PythonShell=_require7.PythonShell;function pythonroad(){var r;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return r=new Promise(function(s){PythonShell.run("test.py",null,function(e,r){var t,n;if(e)throw e;for(obj=JSON.parse(r),record=0;record<Object.keys(obj).length;record++)user_id=obj[record].id,rate_data=obj[record].data,rate_date=obj[record].date,rate_time=obj[record].time,client.query("SELECT * FROM usertest WHERE deviceid = ?",[user_id],function(e,r){if(t=r[0].username,n=r[0].email,r[0].numlimit<rate_data){var s=new Date,i=new Date(rate_date+" "+rate_time).getTime(),o=(s.getTime()-i)/1e3;(o=Math.floor(o))<=300&&porter.sendMail({from:"dayoujianyuan091@gmail.com",to:n,subject:"お知らせ！",text:"".concat(t,"さんは規定の心拍数を超えたことを知らせます。")},function(e,r){e?console.log(e):console.log("Ok send mail!!")})}}),console.log("".concat(record,"個目のレコードのidは").concat(user_id,"・心拍数は").concat(rate_data,"・年月日は").concat(rate_date,"・時間は").concat(rate_time,"です。")),client.query("INSERT INTO datatbl (deviceid,data,date,time) VALUE(?,?,?,?)",[user_id,rate_data,rate_date,rate_time],function(e,r){});s()})}),e.next=4,regeneratorRuntime.awrap(r);case 4:e.next=0;break;case 6:case"end":return e.stop()}})}pythonroad(),app.use(function(e,r,s){void 0===e.session.userId?console.log("ログインしていません"):(console.log("ログインしています"),r.locals.userId=e.session.userId,r.locals.username=e.session.username,r.locals.email=e.session.email,r.locals.password=e.session.password,r.locals.deviceid=e.session.deviceid,r.locals.numlimit=e.session.numlimit),s()}),app.set("views",__dirname+"/views"),app.set("view engine","ejs"),app.get("/",function(e,r,s){console.log(s),r.render("index")}),app.get("/login",function(e,r,s){console.log(s),r.render("login",{errors:[]})}),app.post("/login",function(e,r,s){var i=e.body.email,o=e.body.password,t=[];""===i&&t.push("メールアドレスが空です。"),""===o&&t.push("パスワードが空です。"),0<t.length?r.render("login.ejs",{errors:t}):s()},function(t,n){var e=t.body.email;client.query("SELECT * FROM usertest WHERE email = ?",[e],function(e,s){var i=[];if(0<s.length){var r=t.body.password,o=s[0].password;bcrypt.compare(r,o,function(e,r){r?(t.session.userId=s[0].id,t.session.email=s[0].email,t.session.username=s[0].username,t.session.deviceid=s[0].deviceid,t.session.numlimit=s[0].numlimit,t.session.password=s[0].password,n.redirect("/my")):(i.push("認証失敗しました。"),n.render("login",{errors:i}))})}else i.push("認証に失敗しました。"),n.render("login",{errors:i})})}),app.get("/return",function(e,r){e.session.destroy(function(e){r.redirect("index")})}),app.get("/my",function(e,r){r.render("my")}),app.get("/signup",function(e,r){r.render("signup",{errors:[]})}),app.post("/signup",function(n,a,e){var r=n.body.devicecode;client.query("SELECT deviceid FROM partienttbl WHERE devicecode = ?",[r],function(e,r){if(0<r.length){var o=r[0].deviceid,t=n.body.email;client.query("SELECT * FROM usertest WHERE email = ? or deviceid = ?",[t,o],function(e,r){if(0<r.length)errors.push("このユーザーは既に登録済みです。"),console.log(errors),a.render("signup",{errors:errors});else{var s=n.body.username,i=n.body.password;bcrypt.hash(i,10,function(e,r){client.query("INSERT INTO usertest (username,email,password,deviceid) VALUES(?,?,?,?)",[s,t,r,o],function(e,r){porter.sendMail({from:"dayoujianyuan091@gmail.com",to:t,subject:"医療情報",text:"".concat(s,"さんのユーザー登録が完了しました。")},function(e,r){e?console.log(e):console.log("Ok send mail!!")}),n.session.userId=r.insertId,n.session.username=s,n.session.email=t,n.session.password=i,n.session.deviceid=o,n.session.numlimit=100,a.redirect("/my")})})}})}else console.log("ユーザーコードが間違っています。"),errors.push("ユーザーコードが間違っています。"),a.render("signup",{errors:errors})})}),app.get("/acount",function(e,r){console.log(e.url),r.render("acount")}),app.get("/change",function(e,r){console.log(e.url),r.render("change")}),app.post("/update/:id",function(s,i,e){var o=s.body.username,t=s.body.email,n=s.body.password,a=s.body.deviceid,c=s.body.numlimit,u=s.params.id;1===n.length?client.query("UPDATE usertest SET username = ?, email = ?,deviceid = ?,numlimit = ? WHERE id = ?",[o,t,a,c,u],function(e,r){s.session.userId=u,s.session.email=t,s.session.username=o,s.session.password=n,s.session.numlimit=c,i.redirect("/my")}):bcrypt.hash(n,10,function(e,r){client.query("UPDATE usertest SET username = ?, email = ?, password = ?,deviceid = ?,numlimit = ? WHERE id = ?",[o,t,r,a,c,u],function(e,r){console.log(r),s.session.userId=u,s.session.email=t,s.session.username=o,s.session.password=n,s.session.numlimit=c,i.redirect("/my")})})}),app.post("/delete/:id",function(e,s,r){console.log(e.params.id),client.query("DELETE FROM usertest WHERE id = ?",[e.params.id],function(e,r){s.redirect("/")})}),app.get("/data/:id",function(t,s){console.log(t.url);var n=t.params.id;client.query("SELECT * FROM datatbl WHERE deviceid = ? ;",[n],function(e,s){if(s.forEach(function(e,r){s[r].date=e.date.toLocaleString()}),e)throw e;var r=JSON.stringify(s),i=JSON.parse(r);i.forEach(function(e,r){i[r].date=e.date.substr(0,10)});var o=stringify(i,{header:!0,quoted_string:!1});io.once("connect",function(e){console.log("ユーザーが接続しました");io.emit("datas",o)}),client.query("SELECT numlimit FROM usertest WHERE deviceid = ?",[n],function(e,r){t.session.numlimit=r[0].numlimit;var s=stringify(r,{header:!0,quoted_string:!1});io.once("connection",function(e){console.log("ユーザーが接続しました"),console.log(s),io.emit("limit",s)})})}),client.query("SELECT data FROM datatbl WHERE data = (SELECT MAX(data) FROM datatbl) ; SELECT data FROM datatbl WHERE data = (SELECT MIN(data) FROM datatbl) ",function(e,r){if(e)throw e;s.render("data",{result:r})})}),app.get("/logout",function(e,r){e.session.destroy(function(e){r.redirect("/")})}),server.listen(port,function(){console.log("server start!!")});
//# sourceMappingURL=app.min.js.map
